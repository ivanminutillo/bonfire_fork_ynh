#!/bin/bash

#=================================================
# GENERIC START
#=================================================
# IMPORT GENERIC HELPERS
#=================================================

source _common.sh
source /usr/share/yunohost/helpers

#=================================================
# STOP AND REMOVE DOCKER CONTAINERS
#=================================================
ynh_script_progression --message="Stopping and removing Docker containers..." --weight=1

# Stop and remove containers using docker-compose
if [ -f "$install_dir/docker-compose.yml" ]; then
    cd "$install_dir"
    docker compose -f docker-compose.yml down -v 2>/dev/null || true
fi

# Fallback: manually stop containers if compose fails
docker stop "bonfire-$app" 2>/dev/null || true
docker rm "bonfire-$app" 2>/dev/null || true
docker stop "bonfire-$app-search" 2>/dev/null || true
docker rm "bonfire-$app-search" 2>/dev/null || true

# Remove the custom Docker network
docker network rm "bonfire-$app-net" 2>/dev/null || true

# Optionally remove the Docker images (commented out to allow reuse)
# docker_image=$(ynh_app_setting_get --app=$app --key=docker_image)
# if [ -n "$docker_image" ]; then
#     docker rmi "$docker_image" 2>/dev/null || true
#     docker rmi "getmeili/meilisearch:v1.14" 2>/dev/null || true
# fi

#=================================================
# REMOVE SYSTEM CONFIGURATIONS SERVICE
#=================================================
ynh_script_progression --message="Removing system configurations related to $app..." --weight=1

# Remove the service from the list of services known by YunoHost (added from `yunohost service add`)
if ynh_exec_warn_less yunohost service status $app >/dev/null
then
	ynh_script_progression --message="Removing $app service integration..." --weight=1
	yunohost service remove $app
fi

ynh_remove_systemd_config
ynh_script_progression --message="Removing NGINX web server configuration..." --weight=1

# Remove the dedicated NGINX config
ynh_remove_nginx_config

ynh_remove_logrotate
ynh_secure_remove --file="/var/log/$app"

#=================================================
# END OF SCRIPT
#=================================================

ynh_script_progression --message="Removal of $app completed" --last